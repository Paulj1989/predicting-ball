name: Weekly Monitoring

on:
  schedule:
    # Monday 06:00 UTC â€” after Bundesliga weekend matches are scored
    - cron: '0 6 * * 1'
  workflow_dispatch:
    inputs:
      lookback_days:
        description: 'Days of predictions to analyse'
        type: number
        default: 60
      drift_threshold:
        description: 'RPS drift alert threshold'
        type: number
        default: 0.225

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  monitoring:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Install dependencies
        run: uv pip install --system -e .

      - name: Download DuckDB
        env:
          DO_SPACES_KEY: ${{ secrets.DO_SPACES_KEY }}
          DO_SPACES_SECRET: ${{ secrets.DO_SPACES_SECRET }}
          DO_SPACE_NAME: ${{ secrets.DO_SPACE_NAME }}
          DO_SPACE_REGION: ${{ secrets.DO_SPACE_REGION }}
        run: python scripts/automation/download_db.py

      - name: Run monitoring
        id: monitoring
        run: |
          mkdir -p outputs/evaluation/monitoring
          python scripts/evaluation/run_monitoring.py \
            --lookback-days ${{ inputs.lookback_days || 60 }} \
            --drift-threshold ${{ inputs.drift_threshold || 0.225 }}
        continue-on-error: true

      - name: Upload monitoring report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-report-${{ github.run_id }}
          path: outputs/evaluation/monitoring/monitoring_report.json
          retention-days: 90
          if-no-files-found: ignore

      - name: Create drift alert issue
        if: steps.monitoring.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            let body = 'Weekly monitoring detected a drift or calibration issue.\n\n';
            try {
              const report = JSON.parse(fs.readFileSync('outputs/evaluation/monitoring/monitoring_report.json', 'utf8'));
              body += `| Metric | Value |\n|:---|:---|\n`;
              body += `| Mean RPS | ${report.mean_model_rps?.toFixed(4) ?? 'N/A'} |\n`;
              body += `| Baseline RPS | ${report.mean_baseline_rps?.toFixed(4) ?? 'N/A'} |\n`;
              body += `| Drift detected | ${report.drift_detected} |\n`;
              body += `| Calibration OK | ${report.calibration_ok} |\n`;
            } catch (e) {
              body += 'Could not read monitoring report.\n';
            }
            body += `\n[View Logs](${runUrl})`;
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Monitoring Alert: ${new Date().toLocaleDateString()}`,
              body: body,
              labels: ['monitoring', 'automation'],
            });

  report:
    needs: monitoring
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Create job summary
        env:
          URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          echo "## Monitoring Pipeline: $(date +'%Y-%m-%d')" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Result |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| Monitoring | ${{ needs.monitoring.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow Link**: [View Run]($URL)" >> $GITHUB_STEP_SUMMARY
